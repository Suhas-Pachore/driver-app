<!--
@license
Copyright (c) 2016 The Polymer Project Authors. All rights reserved.
This code may only be used under the BSD style license found at http://polymer.github.io/LICENSE.txt
The complete set of authors may be found at http://polymer.github.io/AUTHORS.txt
The complete set of contributors may be found at http://polymer.github.io/CONTRIBUTORS.txt
Code distributed by Google as part of the polymer project is also
subject to an additional IP rights grant found at http://polymer.github.io/PATENTS.txt
-->

<link rel="import" href="../bower_components/polymer/polymer.html">
<link rel="import" href="../bower_components/iron-ajax/iron-ajax.html">
<link rel="import" href="shared-styles.html">

<dom-module id="my-view3">
  <template>
    <style include="shared-styles">
      .pair {
        background-color: darkred;
        color: white;
        margin: 6px;
        padding: 3px;
      }
      .half {
        width: 45%;
      }
    </style>
    <iron-ajax id="ajaxGetLoad" url="/api/Carriers/getRoundtripLoads" method='POST' handle-as="json" on-response="handleResponse" last-response="{{roundtripLoads}}" content-type="application/json"></iron-ajax>
    <div>
      <h1>Roundtrips</h1>
      <template is="dom-repeat" items="{{roundtripLoadsWithCityNames}}">
        <div class="pair">
            <template is="dom-repeat" items="{{item}}">
              <div class="half">
                {{item.srcCity}}, {{item.srcState}}, {{item.PickupDateTime}}, 
              </div>
              <div class="half"> 
                {{item.dstCity}}, {{item.dstState}}, {{item.DeliveryDateTime}}
                </div>
            </template>
        </div>
      </template>
    </div>
  </template>

  <script>
    Polymer({
      is: 'my-view3',
      attached: function(){
        var self = this;
        var region = {};
        if (navigator.geolocation) {
          navigator.geolocation.getCurrentPosition(function(position){
            region.latitude = position.coords.latitude;
            region.longitude = position.coords.longitude;
            self.$.ajaxGetLoad.body = region;
            self.$.ajaxGetLoad.generateRequest();
          });
        } else { 
          alert("Geolocation feature not supported");
        }
      },
      handleResponse: function(){
        this.loadPairs = this.roundtripLoads.roundtripLoads;
        for(i=0; i<this.loadPairs.length; i++){
            console.log(this.loadPairs[i]);
            this.getCityNames(i,0); 
            this.getCityNames(i,1); 
        }
        var self = this;
        setTimeout(function(){
          self.roundtripLoadsWithCityNames = undefined;
          self.roundtripLoadsWithCityNames = self.loadPairs;
        },700);


      },
      getCityNames: function(i,j){
        var self = this;
        var geocoder1 = new google.maps.Geocoder();
          
        var latlng1 = new google.maps.LatLng(this.loadPairs[i][j].SourceLatitude, this.loadPairs[i][j].SourceLongitude);
          
        geocoder1.geocode(
          {'latLng': latlng1}, 
          function(results, status) {
              if (status == google.maps.GeocoderStatus.OK) {
                if (results[0]) {
                    var add= results[0].formatted_address ;
                    var  value=add.split(",");

                    var count=value.length;
                    var country=value[count-1];
                    var state=value[count-2];
                    var city=value[count-3];
                    self.loadPairs[i][j].srcCity = city;
                    self.loadPairs[i][j].srcState = state;
                    //alert(city,state);
                }
                else  {
                    //alert("address not found");
                }
              }
              else {
                 // alert("Geocoder failed due to: " + status);
              }
          }
        );

        var geocoder2 = new google.maps.Geocoder();
        var latlng2 = new google.maps.LatLng(this.loadPairs[i][j].DestinationLatitude, this.loadPairs[i][j].DestinationLongitude);
          
        geocoder2.geocode(
          {'latLng': latlng2}, 
          function(results, status) {
              if (status == google.maps.GeocoderStatus.OK) {
                if (results[0]) {
                    var add= results[0].formatted_address ;
                    var  value=add.split(",");

                    var count=value.length;
                    var country=value[count-1];
                    var state=value[count-2];
                    var city=value[count-3];
                    self.loadPairs[i][j].dstCity = city;
                    self.loadPairs[i][j].dstState = state;
                    //alert(city,state);
                }
                else  {
                    //alert("address not found");
                }
              }
              else {
                 // alert("Geocoder failed due to: " + status);
              }
          }
        );
      }
    });
  </script>
</dom-module>
