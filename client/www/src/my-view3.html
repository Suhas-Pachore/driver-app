<!--
@license
Copyright (c) 2016 The Polymer Project Authors. All rights reserved.
This code may only be used under the BSD style license found at http://polymer.github.io/LICENSE.txt
The complete set of authors may be found at http://polymer.github.io/AUTHORS.txt
The complete set of contributors may be found at http://polymer.github.io/CONTRIBUTORS.txt
Code distributed by Google as part of the polymer project is also
subject to an additional IP rights grant found at http://polymer.github.io/PATENTS.txt
-->

<link rel="import" href="../bower_components/polymer/polymer.html">
<link rel="import" href="../bower_components/iron-ajax/iron-ajax.html">
<link rel="import" href="shared-styles.html">

<dom-module id="my-view3">
  <template>
    <style include="shared-styles">
    </style>
    <iron-ajax id="ajaxGetLoad" url="/api/Carriers/getRoundtripLoads" method='POST' handle-as="json" on-response="handleResponse" last-response="{{roundtripLoads}}" content-type="application/json"></iron-ajax>
    <div class="card">
      <div class="circle">3</div>
      <h1>Roundtrips</h1>
      <template is="dom-repeat" items="{{roundtripLoadsWithCityNames}}">
        <div class="card">
            Location - {{item.City}}, State - {{item.State}}, Pickup Date - {{item.PickupDateTime}}, Delivery Date -{{item.DeliveryDateTime}}
        </div>
      </template>
    </div>
  </template>

  <script>
    Polymer({
      is: 'my-view3',
      attached: function(){
        var self = this;
        var region = {};
        if (navigator.geolocation) {
          navigator.geolocation.getCurrentPosition(function(position){
            region.latitude = position.coords.latitude;
            region.longitude = position.coords.longitude;
            self.$.ajaxGetLoad.body = region;
            self.$.ajaxGetLoad.generateRequest();
          });
        } else { 
          alert("Geolocation feature not supported");
        }
      },
      handleResponse: function(){
        this.loads = this.roundtripLoads.roundtripLoads[0].drops;
          console.log(this.roundtripLoads);
        for(i=0; i<this.loads.length; i++){
            console.log(this.loads[i]);
          this.getCityNames(i); 
        }
        var self = this;
        setTimeout(function(){
          self.roundtripLoadsWithCityNames = undefined;
          self.roundtripLoadsWithCityNames = self.loads;
        },300);


      },
      getCityNames: function(i){
        var self = this;
        var geocoder = new google.maps.Geocoder();
          
        var latlng = new google.maps.LatLng(this.loads[i].DestinationLatitude, this.loads[i].DestinationLongitude);
          
        geocoder.geocode(
          {'latLng': latlng}, 
          function(results, status) {
              if (status == google.maps.GeocoderStatus.OK) {
                if (results[0]) {
                    var add= results[0].formatted_address ;
                    var  value=add.split(",");

                    var count=value.length;
                    var country=value[count-1];
                    var state=value[count-2];
                    var city=value[count-3];
                    self.loads[i].City = city;
                    self.loads[i].State = state;
                    //alert(city,state);
                }
                else  {
                    //alert("address not found");
                }
              }
              else {
                 // alert("Geocoder failed due to: " + status);
              }
          }
        );
      }
    });
  </script>
</dom-module>
