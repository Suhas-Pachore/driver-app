<!--
@license
Copyright (c) 2016 The Polymer Project Authors. All rights reserved.
This code may only be used under the BSD style license found at http://polymer.github.io/LICENSE.txt
The complete set of authors may be found at http://polymer.github.io/AUTHORS.txt
The complete set of contributors may be found at http://polymer.github.io/CONTRIBUTORS.txt
Code distributed by Google as part of the polymer project is also
subject to an additional IP rights grant found at http://polymer.github.io/PATENTS.txt
-->

<link rel="import" href="../bower_components/polymer/polymer.html">
<link rel="import" href="../bower_components/iron-ajax/iron-ajax.html">
<link rel="import" href="shared-styles.html">
<link rel="import" href="../bower_components/iron-icon/iron-icon.html">
<link rel="import" href="../bower_components/paper-icon-button/paper-icon-button.html">

<dom-module id="my-view3">
  <template>
    <style include="shared-styles">
		.flex-layout{
			display:flex
		}
    </style>
    <iron-ajax id="ajaxGetLoad" url="/api/Carriers/getRoundtripLoads" method='POST' handle-as="json" on-response="handleResponse" last-response="{{roundtripLoads}}" content-type="application/json"></iron-ajax>
    <div>
      <h1 class="background-color">Roundtrips</h1>
      <template is="dom-repeat" items="{{roundtripLoadsWithCityNames}}">
        <div class="card" style="padding:3px;margin:0px;background-color:#E53935;">
            <template is="dom-repeat" items="{{item}}">
			<div class="flex-layout" style="margin:6px;background-color:rgba(255,255,255,.75);padding:9px">
              <div style="flex:2;">
                <div><strong>{{item.srcCity}}</strong></div>
				<div>{{item.srcState}}</div> 
				<div>{{changeDate(item.PickupDateTime)}}</div> 
              </div>
			  <div style="flex:1">
				<paper-icon-button icon="trending-flat"></paper-icon-button>
			  </div> 
              <div style="flex:2"> 
                <div><strong>{{item.dstCity}}</strong></div> 
				<div>{{item.dstState}}</div> 
				<div>{{changeDate(item.DeliveryDateTime)}}</div>
                </div>
			</div>
            </template>
        </div>
      </template>
    </div>
  </template>

  <script>
    Polymer({
      is: 'my-view3',
      attached: function(){
        var self = this;
        var region = {};
        if (navigator.geolocation) {
          navigator.geolocation.getCurrentPosition(function(position){
            region.latitude = position.coords.latitude;
            region.longitude = position.coords.longitude;
            self.$.ajaxGetLoad.body = region;
            self.$.ajaxGetLoad.generateRequest();
          });
        } else { 
          alert("Geolocation feature not supported");
        }
      },
	  changeDate: function(date){
	    var date = new Date();
		return date.getDate() + "/" + (date.getMonth()+1) + "/" + (1900+ date.getYear())+ " " + date.getUTCHours() + ":" + date.getUTCMinutes();
	  },
      handleResponse: function(){
        this.loadPairs = this.roundtripLoads.roundtripLoads;
        for(i=0; i<this.loadPairs.length; i++){
            console.log(this.loadPairs[i]);
            this.getCityNames(i,0); 
            this.getCityNames(i,1); 
        }
        var self = this;
        setTimeout(function(){
          self.roundtripLoadsWithCityNames = undefined;
          self.roundtripLoadsWithCityNames = self.loadPairs;
        },700);


      },
      getCityNames: function(i,j){
        var self = this;
        var geocoder1 = new google.maps.Geocoder();
          
        var latlng1 = new google.maps.LatLng(this.loadPairs[i][j].SourceLatitude, this.loadPairs[i][j].SourceLongitude);
          
        geocoder1.geocode(
          {'latLng': latlng1}, 
          function(results, status) {
              if (status == google.maps.GeocoderStatus.OK) {
                if (results[0]) {
                    var add= results[0].formatted_address ;
                    var  value=add.split(",");

                    var count=value.length;
                    var country=value[count-1];
                    var state=value[count-2];
                    var city=value[count-3];
                    self.loadPairs[i][j].srcCity = city;
                    self.loadPairs[i][j].srcState = state;
                    //alert(city,state);
                }
                else  {
                    //alert("address not found");
                }
              }
              else {
                 // alert("Geocoder failed due to: " + status);
              }
          }
        );

        var geocoder2 = new google.maps.Geocoder();
        var latlng2 = new google.maps.LatLng(this.loadPairs[i][j].DestinationLatitude, this.loadPairs[i][j].DestinationLongitude);
          
        geocoder2.geocode(
          {'latLng': latlng2}, 
          function(results, status) {
              if (status == google.maps.GeocoderStatus.OK) {
                if (results[0]) {
                    var add= results[0].formatted_address ;
                    var  value=add.split(",");

                    var count=value.length;
                    var country=value[count-1];
                    var state=value[count-2];
                    var city=value[count-3];
                    self.loadPairs[i][j].dstCity = city;
                    self.loadPairs[i][j].dstState = state;
                    //alert(city,state);
                }
                else  {
                    //alert("address not found");
                }
              }
              else {
                 // alert("Geocoder failed due to: " + status);
              }
          }
        );
      }
    });
  </script>
</dom-module>
